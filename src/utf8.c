#include "utf8.h"

#include <stdio.h>
#include <stdlib.h>

static int unsigned utf_len_lookup[254] = {
    // 0-127 are all 1 byte long (0b0xxxx xxxx)
    // 128-191 (0b10xx xxxx) indicate we are mid-character, so 0
    // 192-223 (0xb110x xxxx) are all 2 bytes
    // 224-239 (0b1110 xxxx) are all 3 bytes
    // 240-247 (0b1111 0xxx) are all 4 bytes
    // 248-251 (0b1111 10xx) are all 5 bytes
    // 252-253 (0b1111 110x) are all 6 bytes
    // 254-255 are invalid (0b1111 1110 and 0b1111 1111)
    0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1,
    0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1,
    0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1,
    0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1,
    0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1,
    0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1,
    0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1,
    0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1,
    0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1,

    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
    0x0, 0x0, 0x0, 0x0,

    0x2, 0x2, 0x2, 0x2, 0x2, 0x2, 0x2, 0x2, 0x2, 0x2, 0x2, 0x2, 0x2, 0x2, 0x2,
    0x2, 0x2, 0x2, 0x2, 0x2, 0x2, 0x2, 0x2, 0x2, 0x2, 0x2, 0x2, 0x2, 0x2, 0x2,
    0x2, 0x2,

    0x3, 0x3, 0x3, 0x3, 0x3, 0x3, 0x3, 0x3, 0x3, 0x3, 0x3, 0x3, 0x3, 0x3, 0x3,
    0x3,

    0x4, 0x4, 0x4, 0x4, 0x4, 0x4, 0x4, 0x4,

    0x5, 0x5, 0x5, 0x5, 0x6, 0x6,
};

/*
Returns the length, in bytes, of the first utf8 character in the string.
A return value of 0 indicates this byte is in the middle of a character or is
not a valid utf8 starting byte
*/
int unsigned utf8_char_len(char *str) {
  if ((unsigned char)str[0] > 253) {
    printf("INVALID UTF8 byte\n");
    exit(EXIT_FAILURE);
  }
  return utf_len_lookup[(unsigned char)str[0]];
}

char first_byte_masks[6] = {
    0xFF, 0x1F, 0x0F, 0x07, 0x03, 0x01,
};

codepoint utf8_char(char *str, int unsigned *len) {
  *len = utf8_char_len(str);
  if (*len == 1) {
    return (codepoint)str[0];
  }
  codepoint cp = str[0] & first_byte_masks[*len - 1];
  for (int unsigned i = 1; i < *len; i++) {
    cp = (cp << 6) | (str[i] & 0x3F);
  }
  return cp;
}
